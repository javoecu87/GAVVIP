<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solicitar Taxi</title>

  <!-- Estilos -->
  <style>
    body { margin:0; padding:0; font-family:Arial, sans-serif; height:100vh; display:flex; flex-direction:column; align-items:center; background:#366E73; color:#FFE786; position:relative; }
    #map { width:100%; height:100vh; position:absolute; top:0; left:0; z-index:1; }

    .options-container {
      position:absolute; bottom:0; width:100%; height:40%; background:rgba(0,0,0,0.6);
      padding:20px; border-radius:20px 20px 0 0; text-align:center; z-index:2; display:flex;
      flex-wrap:wrap; justify-content:center; gap:15px; align-items:center;
    }
    .btn-bubble { width:85px; height:85px; border-radius:50%; border:none; font-size:14px; font-weight:bold; cursor:pointer; transition:all .3s; display:flex; align-items:center; justify-content:center; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,.3); }
    .btn-yellow { background:#FFD24C; color:#1F3B5C; } .btn-yellow:hover{ background:#FFBA42; transform:scale(1.1); }
    .btn-gray { background:#444; color:#fff; width:140px; height:50px; border-radius:10px; } .btn-gray:hover{ background:#333; }
    .note { font-size:12px; color:#fff; text-align:center; }

    .destination-container {
      display:none; position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
      width:92%; max-width:420px; background:rgba(0,0,0,.6); padding:15px; border-radius:10px; text-align:center; z-index:2;
    }
    input { width:100%; padding:10px; margin-top:10px; border-radius:5px; border:none; font-size:16px; text-align:center; color:#fff; background:rgba(255,255,255,.2); }
    input::placeholder { color:rgba(255,255,255,.8); }
    .hint { font-size:12px; color:#FFE786; margin-top:6px; opacity:.9; }
  </style>

  <!-- Firebase (compat para máxima compatibilidad) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQldjdCRIWhdXc_gz81TPr1xGyK6K5z1w&libraries=places"></script>
</head>
<body>
  <div id="map"></div>

  <div class="options-container" id="selectionBox">
    <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('TAXI')">TAXI</button>
    <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('SUV')">SUV</button>
    <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('VAN')">VAN</button>
    <div style="display:flex; flex-direction:column; align-items:center;">
      <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('MOTO')">MOTO</button>
      <p class="note">Solo 1 pasajero</p>
    </div>
    <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('ENTREGAS')">ENTREGAS</button>
    <button class="btn-gray" onclick="window.location.href='/principal'">Regresar</button>
  </div>

  <div class="destination-container" id="destinationBox">
    <input type="text" id="origen" placeholder="Tu ubicación (auto)" readonly>
    <input type="text" id="destino1" placeholder="Destino (puedes tocar el mapa)">
    <div class="hint">Tip: toca el mapa para fijar el destino (rellena este campo automáticamente).</div>
    <button class="btn-yellow" onclick="alert('Aún no implementado: múltiples destinos')">+ Agregar otro destino</button>
    <button class="btn-gray" onclick="solicitarTaxi()">Solicitar</button>
  </div>

  <script>
    // ---------------------------
    // Config Firebase (mismo proyecto)
    // ---------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCZNdViSZxd6ORwlP89bx-zX16ku4ZmFD0",
      authDomain: "gavvip-b7039.firebaseapp.com",
      databaseURL: "https://gavvip-b7039-default-rtdb.firebaseio.com",
      projectId: "gavvip-b7039",
      storageBucket: "gavvip-b7039.appspot.com",
      messagingSenderId: "803660953782",
      appId: "1:803660953782:web:39c00063caaaaa99c84e17"
    };
    let db;
    (function initFirebaseSafely(){
      try {
        const app = firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        console.log('[TAXI] Firebase inicializado OK');
      } catch(e){
        console.error('[TAXI] Error init Firebase:', e);
      }
    })();

    // ---------------------------
    // Estado global
    // ---------------------------
    let map, userMarker, destMarker, geocoder;
    let userLocation = null;
    let selectedService = null;

    // Lee datos del registro (si existen) para adjuntar al pedido
    function getUsuarioLocal(){
      try {
        const raw = localStorage.getItem('registro_usuario');
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    // ---------------------------
    // Mapa
    // ---------------------------
    function initMap(){
      geocoder = new google.maps.Geocoder();

      navigator.geolocation.getCurrentPosition( (position) => {
        userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };

        map = new google.maps.Map(document.getElementById('map'), {
          center: userLocation,
          zoom: 14
        });

        // Marcador de usuario
        userMarker = new google.maps.Marker({
          position: userLocation,
          map,
          title: 'Tu ubicación',
          icon: { url: '/static/images/icono-taxi.png', scaledSize: new google.maps.Size(40, 40) }
        });

        // Autorrellenar ORIGEN con coords
        const origenInput = document.getElementById('origen');
        origenInput.value = `Lat: ${userLocation.lat.toFixed(5)}, Lng: ${userLocation.lng.toFixed(5)}`;

        // Permitir marcar DESTINO tocando el mapa
        map.addListener('click', (e) => {
          // Solo si ya abrió la caja de destinos
          if (document.getElementById('destinationBox').style.display !== 'block') return;

          const latLng = e.latLng;
          const lat = latLng.lat();
          const lng = latLng.lng();

          if (!destMarker){
            destMarker = new google.maps.Marker({
              position: {lat, lng},
              map,
              title: 'Destino',
              icon: { url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png' }
            });
          } else {
            destMarker.setPosition({lat, lng});
          }

          // Llenar el input con lat/lng
          const destinoInput = document.getElementById('destino1');
          destinoInput.value = `Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`;

          // (Opcional) Intentar reverse geocoding para “bonito”
          geocoder.geocode({ location: {lat, lng} }, (results, status) => {
            if (status === 'OK' && results && results[0]) {
              destinoInput.value = results[0].formatted_address;
            }
          });
        });

      }, () => {
        // Fallback Quito centro
        userLocation = { lat: -0.180653, lng: -78.467834 };
        map = new google.maps.Map(document.getElementById('map'), { center: userLocation, zoom: 14 });
        userMarker = new google.maps.Marker({
          position: userLocation,
          map,
          title: 'Tu ubicación (aproximada)',
          icon: { url: '/static/images/icono-taxi.png', scaledSize: new google.maps.Size(40, 40) }
        });
        const origenInput = document.getElementById('origen');
        origenInput.value = `Lat: ${userLocation.lat.toFixed(5)}, Lng: ${userLocation.lng.toFixed(5)}`;
      });
    }

    // ---------------------------
    // UI
    // ---------------------------
    function seleccionarServicio(servicio){
      selectedService = servicio;
      document.getElementById('selectionBox').style.display = 'none';
      document.getElementById('destinationBox').style.display = 'block';

      // hint: ya rellenamos origen arriba; destino se puede marcar en el mapa
    }
    window.seleccionarServicio = seleccionarServicio;

    async function solicitarTaxi(){
      if (!db){
        alert('No se pudo enviar el pedido. Revisa tu conexión.');
        console.error('[TAXI] DB no inicializada');
        return;
      }

      const origenTexto = (document.getElementById('origen').value || '').trim();
      const destinoTexto = (document.getElementById('destino1').value || '').trim();

      if (!selectedService){
        alert('Elige un tipo de servicio (Taxi, SUV, Van, Moto).');
        return;
      }
      if (!userLocation){
        alert('Aún no obtenemos tu ubicación. Activa GPS e inténtalo de nuevo.');
        return;
      }
      if (!destinoTexto){
        alert('Especifica el destino (puedes tocar el mapa para fijarlo).');
        return;
      }

      const usuario = getUsuarioLocal();
      const pedido = {
        estado: 'pendiente',
        servicio: selectedService,
        timestamp: Date.now(),
        origen: { lat: userLocation.lat, lng: userLocation.lng },
        origenTexto,
        destinoTexto,
        cliente: usuario ? {
          nombre: usuario.nombre || '',
          telefono: usuario.telefono || '',
          correo: usuario.correo || ''
        } : { nombre:'', telefono:'', correo:'' }
      };

      try {
        const ref = db.ref('pedidos/pendientes');
        const nuevoRef = await ref.push(pedido);
        console.log('[TAXI] Pedido creado:', nuevoRef.key);
        alert('Solicitud enviada. Esperando asignación de conductor…');
        // (Opcional) aquí podrías suscribirte a `pedidos/asignados/${nuevoRef.key}` para mostrar “Conductor asignado”.
      } catch (e){
        console.error('[TAXI] Error al publicar pedido:', e);
        alert('Solicitud no enviada. Revisa tu conexión.');
      }
    }
    window.solicitarTaxi = solicitarTaxi;

    window.onload = () => {
      document.getElementById('selectionBox').style.display = 'flex';
      initMap();
    };
  </script>
</body>
</html>
