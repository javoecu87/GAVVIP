<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitar Taxi</title>

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQldjdCRIWhdXc_gz81TPr1xGyK6K5z1w&libraries=places"></script>

  <!-- Firebase v9 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref as dbRef, push, onValue } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

    // --- Firebase config (mismo proyecto) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCZNdViSZxd6ORwlP89bx-zX16ku4ZmFD0",
      authDomain: "gavvip-b7039.firebaseapp.com",
      databaseURL: "https://gavvip-b7039-default-rtdb.firebaseio.com",
      projectId: "gavvip-b7039",
      storageBucket: "gavvip-b7039.appspot.com",
      messagingSenderId: "803660953782",
      appId: "1:803660953782:web:39c00063caaaaa99c84e17"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Estado global ---
    let map;
    let userLocation = null;
    let selectedService = null;
    const markers = [];
    let currentPedidoId = null;
    let asignacionUnsub = null;

    // --- Util: leer usuario del registro local (si existe) ---
    function getUsuarioLocal() {
      try {
        const raw = localStorage.getItem('registro_usuario');
        return raw ? JSON.parse(raw) : null;
      } catch {
        return null;
      }
    }

    // --- Cargar conductores (si ya los pintabas) ---
    function loadConductores() {
      // Si luego quieres pintar conductores en el mapa, puedes leer de:
      // ref(db, 'conductores') y crear markers. Mantengo tu firma por compatibilidad.
    }

    // --- Mapa ---
    window.initMap = function () {
      navigator.geolocation.getCurrentPosition(function (position) {
        userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        map = new google.maps.Map(document.getElementById("map"), {
          center: userLocation,
          zoom: 14
        });
        loadConductores();
      }, function () {
        const fallback = { lat: -0.180653, lng: -78.467834 };
        userLocation = fallback;
        map = new google.maps.Map(document.getElementById("map"), {
          center: fallback,
          zoom: 14
        });
        loadConductores();
      });
    };

    // --- UI handlers ---
    window.seleccionarServicio = function (servicio) {
      selectedService = servicio;
      document.getElementById("selectionBox").style.display = "none";
      document.getElementById("destinationBox").style.display = "block";

      // Autorrellenar origen (texto) si quieres (opcional)
      const origen = document.getElementById("origen");
      if (userLocation) {
        origen.value = `Lat: ${userLocation.lat.toFixed(5)}, Lng: ${userLocation.lng.toFixed(5)}`;
      }
    };

    // Publicar pedido
    async function publicarPedidoEnFirebase(pedido) {
      try {
        const pedidosRef = dbRef(db, 'pedidos/pendientes');
        const nuevoRef = await push(pedidosRef, pedido);
        console.log('[TAXI] Pedido creado:', nuevoRef.key);
        return nuevoRef.key;
      } catch (err) {
        console.error('[TAXI] Error al publicar pedido:', err);
        alert('No se pudo enviar el pedido. Revisa tu conexión.');
        return null;
      }
    }

    // Escuchar asignación del pedido
    function escucharAsignacion(pedidoId) {
      // Limpia escucha previa
      if (asignacionUnsub) asignacionUnsub();

      const asignadoRef = dbRef(db, `pedidos/asignados/${pedidoId}`);
      const off = onValue(asignadoRef, (snap) => {
        const data = snap.val();
        if (!data) return;
        // Asignado
        const status = document.getElementById('statusText');
        status.textContent = `Conductor asignado: ${data.nombreConductor} • Placa: ${data.placa} • ${data.tipoVehiculo}`;
        document.getElementById('statusBadge').textContent = 'ASIGNADO';
      });
      asignacionUnsub = () => off();
    }

    window.solicitarTaxi = async function () {
      // lee inputs
      const origenInput = document.getElementById('origen');
      const destinoInput = document.getElementById('destino1');

      const usuario = getUsuarioLocal(); // {nombre, telefono, correo,...} si existe
      const pedido = {
        estado: 'pendiente',
        servicio: selectedService || 'TAXI',
        timestamp: Date.now(),
        origen: userLocation ? { lat: userLocation.lat, lng: userLocation.lng } : null,
        origenTexto: origenInput?.value || '',
        destinoTexto: destinoInput?.value || '',
        cliente: usuario ? {
          nombre: usuario.nombre || '',
          telefono: usuario.telefono || '',
          correo: usuario.correo || ''
        } : {
          nombre: '',
          telefono: '',
          correo: ''
        }
      };

      // Mostrar mini-estado
      document.getElementById('statusPanel').style.display = 'block';
      document.getElementById('statusBadge').textContent = 'BUSCANDO';
      document.getElementById('statusText').textContent = 'Buscando conductor disponible…';

      const pedidoId = await publicarPedidoEnFirebase(pedido);
      if (!pedidoId) return;
      currentPedidoId = pedidoId;

      // Suscribirse a la asignación
      escucharAsignacion(pedidoId);

      alert('Solicitud enviada. Esperando asignación de conductor…');
    };

    window.onload = function () {
      document.getElementById("selectionBox").style.display = "flex";
    };
  </script>

  <style>
    body { margin:0; padding:0; font-family: Arial, sans-serif; height:100vh; display:flex; flex-direction:column; align-items:center; background-color:#366E73; color:#FFE786; position:relative; }
    #map { width:100%; height:100vh; position:absolute; top:0; left:0; z-index:1; }
    .options-container {
      position:absolute; bottom:0; width:100%; height:40%; background:rgba(0,0,0,0.6);
      padding:20px; border-radius:20px 20px 0 0; text-align:center; z-index:2; display:flex;
      flex-wrap:wrap; justify-content:center; gap:15px; align-items:center;
    }
    .btn-bubble { width:85px; height:85px; border-radius:50%; border:none; font-size:14px; font-weight:bold; cursor:pointer; transition:all .3s; display:flex; align-items:center; justify-content:center; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,.3); }
    .btn-yellow { background:#FFD24C; color:#1F3B5C; } .btn-yellow:hover { background:#FFBA42; transform:scale(1.1); }
    .btn-gray { background:#444; color:#fff; width:140px; height:50px; border-radius:10px; } .btn-gray:hover { background:#333; }
    .note { font-size:12px; color:#fff; text-align:center; }

    .destination-container {
      display:none; position:absolute; bottom:20px; width:90%; max-width:420px; background:rgba(0,0,0,.6);
      padding:15px; border-radius:10px; text-align:center; z-index:2;
    }
    input { width:100%; padding:10px; margin-top:10px; border-radius:5px; border:none; font-size:16px; text-align:center; color:#fff; background:rgba(255,255,255,.2); }
    input::placeholder { color:rgba(255,255,255,.7); }

    /* Mini-estado del pedido */
    .status-panel {
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.65); color:#fff; padding:10px 14px; border-radius:12px; z-index:3;
      display:none; min-width:260px;
    }
    .status-badge {
      display:inline-block; font-weight:bold; background:#FFD24C; color:#1F3B5C; padding:4px 8px; border-radius:10px; margin-right:8px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Mini estado -->
  <div class="status-panel" id="statusPanel">
    <span class="status-badge" id="statusBadge">BUSCANDO</span>
    <span id="statusText">Buscando conductor disponible…</span>
  </div>

  <div class="options-container" id="selectionBox">
    <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('TAXI')">TAXI</button>
    <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('SUV')">SUV</button>
    <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('VAN')">VAN</button>
    <div style="display:flex; flex-direction:column; align-items:center;">
      <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('MOTO')">MOTO</button>
      <p class="note">Solo 1 pasajero</p>
    </div>
    <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('ENTREGAS')">ENTREGAS</button>
    <button class="btn-gray" onclick="window.location.href='/principal'">Regresar</button>
  </div>

  <div class="destination-container" id="destinationBox">
    <input type="text" id="origen" placeholder="Ingrese Punto de Partida" readonly>
    <input type="text" id="destino1" placeholder="Destino">
    <button class="btn-yellow" onclick="alert('Aún no implementado: múltiples destinos')">+ Agregar otro destino</button>
    <button class="btn-gray" onclick="solicitarTaxi()">Solicitar</button>
  </div>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQldjdCRIWhdXc_gz81TPr1xGyK6K5z1w&callback=initMap"></script>
</body>
</html>
