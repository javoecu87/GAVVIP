<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Solicitar Taxi - GAVVIP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#121212" />
  <style>
    :root{
      --bg:#121212;
      --panel:#1d1d1d;
      --muted:#2a2a2a;
      --text:#ffffff;
      --sub:#bdbdbd;
      --brand:#FFD24C;   /* Dorado fuerte */
      --brand-dark:#FFBA42; /* Dorado oscuro */
      --error:#ff6b6b;
      --ok:#6BFF95;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: Arial, sans-serif;
    }

    /* Contenedor principal centrado y responsivo */
    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 18px 16px 48px;
    }

    .brand{
      display:flex; align-items:center; gap:10px; margin:10px 0 18px;
    }
    .logo{
      width:36px; height:36px; border-radius:10px; background:var(--brand);
      display:inline-flex; align-items:center; justify-content:center; font-weight:900; color:#000;
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    h1{
      font-size: 20px; margin:0;
    }
    p.sub{
      margin:6px 0 0; color:var(--sub); font-size:13px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15));
      border:1px solid var(--muted);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    label{ display:block; margin-top: 12px; font-size: 13px; color:var(--sub); }
    input, select, textarea{
      width:100%; margin-top:6px;
      background: var(--panel); color: var(--text);
      border: 1px solid var(--muted); border-radius: 14px;
      outline: none; padding: 12px 12px;
      font-size: 15px;
      transition: border .2s ease, background .2s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: var(--brand);
      background: #222;
    }
    textarea{ resize: vertical; min-height: 84px; }

    .row{
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }

    .actions{
      margin-top:16px; display: grid; grid-template-columns: 1fr; gap:10px;
    }
    button{
      border: none; border-radius: 16px; padding: 14px 16px;
      font-weight: 800; letter-spacing:.2px;
      background: var(--brand); color:#000;
      cursor: pointer;
      transition: transform .05s ease, filter .2s ease, background .2s ease;
    }
    button:hover{ filter: brightness(1.02); }
    button:active{ transform: translateY(1px) scale(0.997); }
    button.secondary{
      background: transparent; color: var(--text);
      border:1px solid var(--muted);
    }
    button:disabled{
      opacity:.65; cursor:not-allowed;
    }

    .msg{ margin-top: 10px; font-size: 14px; min-height: 18px; }
    .msg.err{ color: var(--error); }
    .msg.ok{ color: var(--ok); }

    .hint{
      font-size:12px; color:var(--sub); margin-top:6px;
    }

    /* Footer fijo opcional */
    .footer{
      position: fixed; left:0; right:0; bottom:0; padding:10px 16px;
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.45));
      backdrop-filter: blur(6px);
    }
    .footer .cap{
      max-width:520px; margin:0 auto; font-size:11px; color:var(--sub);
    }
  </style>
</head>
<body
  <!--
    Si tu backend está en otro dominio (por ejemplo Render),
    coloca aquí el endpoint absoluto, por ejemplo:
    data-endpoint="https://gavvip.onrender.com/api/taxi"
  -->
  data-endpoint=""
>
  <div class="wrap">
    <div class="brand">
      <div class="logo">GV</div>
      <div>
        <h1>Solicitar Taxi</h1>
        <p class="sub">Completa los datos y envía tu pedido</p>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label for="nombre">Nombre*</label>
          <input id="nombre" placeholder="Tu nombre" autocomplete="name" />
        </div>
        <div>
          <label for="telefono">Teléfono*</label>
          <input id="telefono" placeholder="+593..." inputmode="tel" autocomplete="tel" />
        </div>
      </div>

      <label for="origen">Origen*</label>
      <input id="origen" placeholder="Punto de partida" autocomplete="street-address" />

      <label for="destino">Destino*</label>
      <input id="destino" placeholder="Destino" />

      <div class="row">
        <div>
          <label for="vehiculo">Vehículo*</label>
          <select id="vehiculo">
            <option value="Sedán">Sedán</option>
            <option value="SUV">SUV</option>
            <option value="Van">Van</option>
            <option value="Alta Gama">Alta Gama</option>
          </select>
        </div>
        <div>
          <label for="nota">Notas</label>
          <input id="nota" placeholder="Opcional (color auto, pago, etc.)" />
        </div>
      </div>

      <div class="actions">
        <button id="btnGeo" class="secondary" type="button">Usar mi ubicación</button>
        <button id="btnEnviar" type="button">Enviar pedido</button>
      </div>

      <div id="msg" class="msg"></div>
      <div id="locHint" class="hint"></div>
    </div>
  </div>

  <div class="footer">
    <div class="cap">GAVVIP · versión Backend+Sheets</div>
  </div>

  <script>
    // ====== Config del endpoint ======
    function getApiEndpoint() {
      const body = document.body;
      const custom = (body.getAttribute("data-endpoint") || "").trim();
      if (custom) return custom; // absoluto configurado por data-endpoint
      // Si no hay data-endpoint, usa el mismo origen y ruta /api/taxi
      return (location.origin || "") + "/api/taxi";
    }

    // ====== Estado de geolocalización ======
    let lastCoords = { lat: null, lng: null };

    function setMsg(text, type) {
      const msg = document.getElementById("msg");
      msg.textContent = text || "";
      msg.className = "msg" + (type ? " " + type : "");
    }

    function setHint(text){
      const el = document.getElementById("locHint");
      el.textContent = text || "";
    }

    async function getLocation() {
      setHint("Obteniendo ubicación...");
      return new Promise((resolve) => {
        try {
          navigator.geolocation.getCurrentPosition(
            pos => {
              const lat = pos.coords.latitude;
              const lng = pos.coords.longitude;
              lastCoords = { lat, lng };
              setHint(`Ubicación lista: ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
              resolve({ lat, lng });
            },
            err => {
              setHint("No se pudo obtener la ubicación (permiso denegado o sin señal).");
              resolve({ lat: null, lng: null });
            },
            { enableHighAccuracy: true, timeout: 7000, maximumAge: 5000 }
          );
        } catch {
          setHint("Tu navegador no soporta geolocalización.");
          resolve({ lat: null, lng: null });
        }
      });
    }

    // ====== Envío del pedido ======
    async function enviarPedido() {
      const btn = document.getElementById("btnEnviar");
      const msg = document.getElementById("msg");

      const nombre = document.getElementById("nombre").value.trim();
      const telefono = document.getElementById("telefono").value.trim();
      const origen = document.getElementById("origen").value.trim();
      const destino = document.getElementById("destino").value.trim();
      const vehiculo = document.getElementById("vehiculo").value;
      const nota = document.getElementById("nota").value.trim();

      // Validación mínima
      const faltantes = [];
      if (!nombre) faltantes.push("nombre");
      if (!telefono) faltantes.push("teléfono");
      if (!origen) faltantes.push("origen");
      if (!destino) faltantes.push("destino");
      if (!vehiculo) faltantes.push("vehículo");

      if (faltantes.length) {
        setMsg("Completa los campos obligatorios: " + faltantes.join(", "), "err");
        return;
      }

      // Si ya se pidió ubicación antes, se envían esas coords; caso contrario intenta obtenerlas rápido
      let lat = lastCoords.lat, lng = lastCoords.lng;
      if (lat === null || lng === null) {
        const r = await getLocation();
        lat = r.lat; lng = r.lng;
      }

      const payload = { nombre, telefono, origen, destino, vehiculo, nota, lat, lng };
      const endpoint = getApiEndpoint();

      setMsg("Enviando pedido...", "");
      btn.disabled = true;

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.success) {
          const errTxt = (data && data.error) ? data.error : `HTTP ${res.status}`;
          setMsg("Error de envío: " + errTxt, "err");
          btn.disabled = false;
          return;
        }

        setMsg("¡Pedido enviado con éxito!", "ok");
        // Limpia algunos campos
        document.getElementById("origen").value = "";
        document.getElementById("destino").value = "";
        document.getElementById("nota").value = "";

      } catch (e) {
        setMsg("Error de envío. Comprueba tu conexión o el endpoint.", "err");
      } finally {
        btn.disabled = false;
      }
    }

    // ====== Listeners ======
    document.getElementById("btnEnviar").addEventListener("click", enviarPedido);
    document.getElementById("btnGeo").addEventListener("click", getLocation);

    // ====== Mejora UX en móviles: mostrar teclado al enfocar destino ======
    document.getElementById("destino").addEventListener("focus", () => {
      window.scrollTo({ top: document.getElementById("destino").offsetTop - 20, behavior: "smooth" });
    });
  </script>
</body>
</html>
