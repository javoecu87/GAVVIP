<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitar Taxi</title>

    <!-- Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQldjdCRIWhdXc_gz81TPr1xGyK6K5z1w&libraries=places"></script>

    <!-- Telegram (opcional) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Firebase SDK (COMPAT: expone `firebase`) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script>
        // Inicializa Firebase de forma segura (sin romper lo existente)
        (function initFirebaseSafely(){
            function init(){
                if (!window.firebase) return;
                const cfg = {
                    apiKey: "AIzaSyCZNdViSZxd6ORwlP89bx-zX16ku4ZmFD0",
                    authDomain: "gavvip-b7039.firebaseapp.com",
                    databaseURL: "https://gavvip-b7039-default-rtdb.firebaseio.com",
                    projectId: "gavvip-b7039",
                    storageBucket: "gavvip-b7039.appspot.com",
                    messagingSenderId: "803660953782",
                    appId: "1:803660953782:web:39c00063caaaaa99c84e17"
                };
                if (!firebase.apps.length) {
                    window._gavvipFirebaseApp = firebase.initializeApp(cfg);
                } else {
                    window._gavvipFirebaseApp = firebase.apps[0];
                }
                window._gavvipDB = firebase.database();
            }
            if (window.firebase) init(); else window.addEventListener('load', init);
        })();
    </script>

    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; align-items: center; background-color: #366E73; color: #FFE786; position: relative; }
        #map { width: 100%; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        .options-container { position: absolute; bottom: 0; width: 100%; height: 40%; background: rgba(0,0,0,0.6); padding: 20px; border-radius: 20px 20px 0 0; text-align: center; z-index: 2; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; align-items: center; }
        .btn-bubble { width: 85px; height: 85px; border-radius: 50%; border: none; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease-in-out; display: flex; align-items: center; justify-content: center; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn-yellow { background-color: #FFD24C; color: #1F3B5C; } .btn-yellow:hover { background-color: #FFBA42; transform: scale(1.1); }
        .btn-gray { background-color: #444; color: #fff; width: 140px; height: 50px; border-radius: 10px; } .btn-gray:hover { background-color: #333; }
        .note { font-size: 12px; color: #fff; text-align: center; }
        .destination-container { display: none; position: absolute; bottom: 20px; width: 90%; max-width: 420px; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; text-align: center; z-index: 2; }
        input { width: 100%; padding: 10px; margin-top: 10px; border-radius: 5px; border: none; font-size: 16px; text-align: center; color: #fff; background-color: rgba(255,255,255,0.2); }
        input::placeholder { color: rgba(255,255,255,0.7); }
        /* Mini-estado del viaje */
        .status-panel { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.65); color: #fff; padding: 10px 14px; border-radius: 12px; z-index: 3; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.35); max-width: 92%; }
        .status-title { color: #FFD24C; font-weight: bold; margin-bottom: 4px; }
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.35); border-top-color: #FFD24C; border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; vertical-align: middle; margin-right: 6px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Panel de estado del viaje -->
    <div id="statusPanel" class="status-panel">
        <div id="statusTitle" class="status-title">Estado del viaje</div>
        <div id="statusText">—</div>
    </div>

    <div class="options-container" id="selectionBox">
        <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('TAXI')">TAXI</button>
        <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('SUV')">SUV</button>
        <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('VAN')">VAN</button>
        <div style="display:flex; flex-direction:column; align-items:center;">
            <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('MOTO')">MOTO</button>
            <p class="note">Solo 1 pasajero</p>
        </div>
        <button class="btn-bubble btn-yellow" onclick="seleccionarServicio('ENTREGAS')">ENTREGAS</button>
        <button class="btn-gray" onclick="window.location.href='/principal'">Regresar</button>
    </div>

    <div class="destination-container" id="destinationBox">
        <input type="text" id="origen" placeholder="Ingrese Punto de Partida" readonly>
        <input type="text" id="destino1" placeholder="Destino">
        <input type="text" id="nombre_usuario" placeholder="Tu nombre">
        <input type="text" id="telefono_usuario" placeholder="Tu teléfono">
        <button class="btn-yellow" onclick="agregarDestino()">+ Agregar otro destino</button>
        <button class="btn-gray" onclick="solicitarTaxi()">Solicitar</button>
    </div>

    <script>
        let servicioSeleccionado = "";
        let map, userMarker, driverMarker; // marcadores
        let currentPedidoId = null; // id del pedido en Firebase

        function showStatus(text, title){
            const panel = document.getElementById('statusPanel');
            const st = document.getElementById('statusText');
            const ti = document.getElementById('statusTitle');
            ti.textContent = title || 'Estado del viaje';
            st.innerHTML = text;
            panel.style.display = 'block';
        }
        function hideStatus(){ document.getElementById('statusPanel').style.display = 'none'; }

        async function solicitarPermisoUbicacion(){
            return new Promise((resolve,reject)=>{
                const permiso = confirm('Para continuar, necesitamos acceder a tu ubicación actual.');
                if (permiso) resolve(); else { alert('Debes aceptar el permiso para usar esta funcionalidad.'); reject(); }
            });
        }

        async function initMap(){
            try{
                await solicitarPermisoUbicacion();
                navigator.geolocation.getCurrentPosition(pos=>{
                    const userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    map = new google.maps.Map(document.getElementById('map'), { center: userLocation, zoom: 15 });
                    userMarker = new google.maps.Marker({ position: userLocation, map, title: 'Mi ubicación', icon: { url: '/static/images/icono-taxi.png', scaledSize: new google.maps.Size(40,40) } });
                    document.getElementById('origen').value = `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`;
                }, err=>{ alert('Error obteniendo ubicación: ' + err.message); });
            }catch(e){ console.log('Permiso no otorgado o error: ', e); }
        }

        function seleccionarServicio(servicio){
            servicioSeleccionado = servicio;
            document.getElementById('selectionBox').style.display = 'none';
            document.getElementById('destinationBox').style.display = 'block';
        }
        function agregarDestino(){ alert('Funcionalidad de múltiples destinos aún no implementada.'); }

        // === NUEVO: escribir pedido en Firebase y escuchar asignación ===
        function publicarPedidoEnFirebase(pedido){
            try{
                if (!window._gavvipDB && window.firebase) window._gavvipDB = firebase.database();
                const db = window._gavvipDB; if (!db){ console.warn('Firebase DB no disponible.'); return null; }
                const ref = db.ref('pedidos/pendientes').push();
                const id = ref.key;
                currentPedidoId = id;
                return ref.set({
                    id,
                    estado: 'pendiente',
                    cliente: { nombre: pedido.nombre, telefono: pedido.telefono },
                    servicio: pedido.servicio,
                    origen: pedido.origen, // {lat,lng}
                    destinoTexto: pedido.destino,
                    timestamp: Date.now()
                }).then(()=> id);
            }catch(e){ console.error('No se pudo publicar en Firebase:', e); return null; }
        }

        function escucharAsignacion(pedidoId){
            const db = window._gavvipDB; if (!db) return;
            const asignadoRef = db.ref(`pedidos/asignados/${pedidoId}`);
            asignadoRef.on('value', snap=>{
                const data = snap.val();
                if (!data) return; // aún no asignado
                const { conductorId, nombreConductor, placa, tipoVehiculo } = data;
                showStatus(`<span class="spinner"></span> Conductor asignado: <b>${nombreConductor || '—'}</b> (${placa || '—'} - ${tipoVehiculo || '—'})`, 'Conductor encontrado');
                escucharUbicacionConductor(conductorId);
            });
        }

        function escucharUbicacionConductor(conductorId){
            const db = window._gavvipDB; if (!db) return;
            const ref = db.ref(`conductores/${conductorId}`);
            ref.on('value', snap=>{
                const info = snap.val(); if (!info) return;
                const { lat, lng } = info;
                if (lat == null || lng == null) return;
                const pos = { lat, lng };
                if (!driverMarker){
                    driverMarker = new google.maps.Marker({ position: pos, map, title: 'Conductor', icon: { url: '/static/images/icono-taxi.png', scaledSize: new google.maps.Size(40,40) } });
                } else {
                    driverMarker.setPosition(pos);
                }
            });
        }

        async function solicitarTaxi(){
            const origenTxt = document.getElementById('origen').value.trim();
            const destino = document.getElementById('destino1').value.trim();
            const nombre = document.getElementById('nombre_usuario').value.trim();
            const telefono = document.getElementById('telefono_usuario').value.trim();

            if (!destino || !nombre || !telefono){ alert('Por favor, completa todos los campos.'); return; }

            // Enviar a Google Sheets (se mantiene tal como estaba)
            const datos = { nombre, telefono, correo: '', servicio: servicioSeleccionado, origen: origenTxt, destino, fecha: new Date().toLocaleString() };
            try {
                await fetch('https://script.google.com/macros/s/AKfycbwfYsSyoQGZvvS-6SBZ1sax6l_SuEPB1OHxFNGa7OFsqrJvU5AZKfTR4RB_p03FxXDuiQ/exec', {
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(datos)
                });
            } catch(err){ console.warn('Error al enviar a Sheets (continuamos con Firebase):', err); }

            // Publicar también en Firebase para tiempo real
            let origen = { lat: null, lng: null };
            try {
                if (userMarker) { const p = userMarker.getPosition(); origen = { lat: p.lat(), lng: p.lng() }; }
            } catch {}

            showStatus('<span class="spinner"></span> Buscando conductor…', 'Solicitud enviada');

            const pedidoId = await publicarPedidoEnFirebase({ nombre, telefono, servicio: servicioSeleccionado, origen, destino });
            if (pedidoId){ escucharAsignacion(pedidoId); }
        }

        window.onload = () => { initMap(); document.getElementById('selectionBox').style.display = 'flex'; };
    </script>
</body>
</html>
